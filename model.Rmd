---
title: "model"
author: "Michael Goldschlager"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set Up

### Packages

```{r, echo = FALSE}
library(tidyverse) #dplyr functions mainly
library(DBI) #database
library(RSQLite) #database
library(tictoc) #timing code execution

library(xgboost) # Load XGBoost
library(caret) # Load Caret
library(OptimalCutpoints) # Load optimal cutpoints
library(ggplot2) # Load ggplot2
library(xgboostExplainer) # Load XGboost Explainer
library(pROC) # Load proc
library(SHAPforxgboost) # Load shap for XGBoost
```

### Set Working Directory

```{r}
#wd <- dirname(sys.frame(1)$ofile) #gets the directory where this script is located
#setwd(wd) #sets the working directory to the directory of this script, this is so relative paths can be used below
```

### Connect to Database

```{r}
connection <- DBI::dbConnect(RSQLite::SQLite(), "./data/pbp_db") #create connection for db
```

### Get nfl_data_set table from the database
```{r}
nfl_data_set <- dplyr::tbl(connection, "nfl_data_set") #get the nfl_data_set table from the db
```

# Data Preparation

### Select rows and columns from nfl_data_set we want for the model

```{r}
model_basic_data_use <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, 
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

### Split data into training and testing

```{r}
train_basic <- model_basic_data_use[model_basic_data_use$season %in% c(2018, 2019, 2020), ]
test_basic <- setdiff(model_basic_data_use, train_basic)
```

### Convert data to DMatrix

```{r}
dtrain_basic <- xgb.DMatrix(data = as.matrix(train_basic[, -1]), label = train_basic$point_differential)
dtest_basic <- xgb.DMatrix(data = as.matrix(test_basic[, -1]), label = test_basic$point_differential)
```

# XGBoost Model

### Train Model

```{r}
set.seed(111111)
model_basic <- xgboost(data = dtrain_basic, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

### Variable Importance

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_basic)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 10)
```
### Test Model

```{r}
library(Metrics)

basic_model_preds <- predict(model_basic, dtest_basic)

rmse(test_basic$point_differential, basic_model_preds)
```

# Introduce more variables

### Coaches

```{r}
#get data
model_2_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, home_coach, away_coach,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_2_data <- dummy_cols(model_2_data, select_columns = c("home_coach", "away_coach"))
```

```{r}
#Split data into train and test
train_2 <- model_2_data[model_2_data$season %in% c(2018, 2019, 2020), ]
test_2 <- setdiff(model_2_data, train_2)
```

```{r}
#Convert data to DMatrix
dtrain_2 <- xgb.DMatrix(data = as.matrix(train_2[, -c(1,4,5)]), label = train_2$point_differential)
dtest_2 <- xgb.DMatrix(data = as.matrix(test_2[, -c(1,4,5)]), label = test_2$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_2 <- xgboost(data = dtrain_2, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_2)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_2_preds <- predict(model_2, dtest_2)

rmse(test_2$point_differential, model_2_preds)
```
  
May be worth adding the Sith Lord...

### Adding just Bill Belichick

```{r}
#get data
model_bb_data <- model_2_data[, c(1:3, 6:13)]
model_bb_data <- cbind(model_bb_data, model_2_data[, "away_coach_Bill Belichick"])
```

```{r}
#Split data into train and test
train_bb <- model_bb_data[model_bb_data$season %in% c(2018, 2019, 2020), ]
test_bb <- setdiff(model_bb_data, train_bb)
```

```{r}
#Convert data to DMatrix
dtrain_bb <- xgb.DMatrix(data = as.matrix(train_bb[, -1]), label = train_bb$point_differential)
dtest_bb <- xgb.DMatrix(data = as.matrix(test_bb[, -1]), label = test_bb$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_bb <- xgboost(data = dtrain_bb, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_bb)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_bb_preds <- predict(model_bb, dtest_bb)

rmse(test_bb$point_differential, model_bb_preds)
```

The Sith Lord does not improve model performance. Do not include

### Roof

```{r}
#get data
model_3_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, roof,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_3_data <- dummy_cols(model_3_data, select_columns = "roof")
```

```{r}
#Split data into train and test
train_3 <- model_3_data[model_3_data$season %in% c(2018, 2019, 2020), ]
test_3 <- setdiff(model_3_data, train_3)
```

```{r}
#Convert data to DMatrix
dtrain_3 <- xgb.DMatrix(data = as.matrix(train_3[, -c(1,4)]), label = train_3$point_differential)
dtest_3 <- xgb.DMatrix(data = as.matrix(test_3[, -c(1,4)]), label = test_3$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_3 <- xgboost(data = dtrain_3, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_3)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_3_preds <- predict(model_3, dtest_3)

rmse(test_3$point_differential, model_3_preds)
```

Worse than original. Don't add

### Surface

```{r}
#get data
model_4_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, surface,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_4_data <- dummy_cols(model_4_data, select_columns = "surface")
```

```{r}
#Split data into train and test
train_4 <- model_4_data[model_4_data$season %in% c(2018, 2019, 2020), ]
test_4 <- setdiff(model_4_data, train_4)
```

```{r}
#Convert data to DMatrix
dtrain_4 <- xgb.DMatrix(data = as.matrix(train_4[, -c(1,4)]), label = train_4$point_differential)
dtest_4 <- xgb.DMatrix(data = as.matrix(test_4[, -c(1,4)]), label = test_4$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_4 <- xgboost(data = dtrain_4, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_4)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_4_preds <- predict(model_4, dtest_4)

rmse(test_4$point_differential, model_4_preds)
```

Even fieldturf probably isn't important enough

### Pass and Rush yard quarter breakdowns

```{r}
#get data
model_5_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg, 
                off_passing_yards_qtr_1_home_5w_avg, off_passing_yards_qtr_2_home_5w_avg, off_passing_yards_qtr_3_home_5w_avg, 
                off_passing_yards_qtr_4_home_5w_avg, off_rushing_yards_qtr_1_home_5w_avg, 
                off_rushing_yards_qtr_2_home_5w_avg, off_rushing_yards_qtr_3_home_5w_avg, off_rushing_yards_qtr_4_home_5w_avg, 
                off_passing_yards_qtr_1_away_5w_avg, off_passing_yards_qtr_2_away_5w_avg, off_passing_yards_qtr_3_away_5w_avg, 
                off_passing_yards_qtr_4_away_5w_avg, off_rushing_yards_qtr_1_away_5w_avg, 
                off_rushing_yards_qtr_2_away_5w_avg, off_rushing_yards_qtr_3_away_5w_avg, off_rushing_yards_qtr_4_away_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#Split data into train and test
train_5 <- model_5_data[model_5_data$season %in% c(2018, 2019, 2020), ]
test_5 <- setdiff(model_5_data, train_5)
```

```{r}
#Convert data to DMatrix
dtrain_5 <- xgb.DMatrix(data = as.matrix(train_5[, -1]), label = train_5$point_differential)
dtest_5 <- xgb.DMatrix(data = as.matrix(test_5[, -1]), label = test_5$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_5 <- xgboost(data = dtrain_5, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_5)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_5_preds <- predict(model_5, dtest_5)

rmse(test_5$point_differential, model_5_preds)
```

### Start Time

```{r}
#get data
model_6_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, start_time,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_6_data <- dummy_cols(model_6_data, select_columns = "start_time")
```

```{r}
#Split data into train and test
train_6 <- model_6_data[model_6_data$season %in% c(2018, 2019, 2020), ]
test_6 <- setdiff(model_6_data, train_6)
```

```{r}
#Convert data to DMatrix
dtrain_6 <- xgb.DMatrix(data = as.matrix(train_6[, -c(1,4)]), label = train_6$point_differential)
dtest_6 <- xgb.DMatrix(data = as.matrix(test_6[, -c(1,4)]), label = test_6$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_6 <- xgboost(data = dtrain_6, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_6)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_6_preds <- predict(model_6, dtest_6)

rmse(test_6$point_differential, model_6_preds)
```

Probably not worth including

Actually, after talking to Martin I can just throw in all the variaables and XGBoost will drop ones that aren't useful. Can explore lambda values for penalization.

# Big Model

### Data Preparation

#### Select rows and columns from nfl_data_set we want for the model

```{r}
model_big_data_use <- nfl_data_set %>% 
  dplyr::filter(season_type == "REG") %>%  #consider dropping weeks 1-4, 16,17
  dplyr::select(point_differential, season, week, home_coach, away_coach, roof, surface, start_time,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg, 
                off_passing_yards_qtr_1_home_5w_avg, off_passing_yards_qtr_2_home_5w_avg, off_passing_yards_qtr_3_home_5w_avg, 
                off_passing_yards_qtr_4_home_5w_avg, off_rushing_yards_qtr_1_home_5w_avg, 
                off_rushing_yards_qtr_2_home_5w_avg, off_rushing_yards_qtr_3_home_5w_avg, off_rushing_yards_qtr_4_home_5w_avg,
                off_passing_yards_qtr_1_away_5w_avg, off_passing_yards_qtr_2_away_5w_avg, off_passing_yards_qtr_3_away_5w_avg,
                off_passing_yards_qtr_4_away_5w_avg, off_rushing_yards_qtr_1_away_5w_avg, off_rushing_yards_qtr_2_away_5w_avg,
                off_rushing_yards_qtr_3_away_5w_avg, off_rushing_yards_qtr_4_away_5w_avg,
                home_yac_5w_avg, total_yac_qtr_1_home_5w_avg, total_yac_qtr_2_home_5w_avg, total_yac_qtr_3_home_5w_avg,
                total_yac_qtr_4_home_5w_avg, home_total_plays_5w_avg, total_sacks_home_5w_avg, total_ints_home_5w_avg,
                total_sacks_allow_home_5w_avg, total_ints_throw_home_5w_avg, home_total_time_pos_5w_avg,
                off_pass_yards_tot_home_defense_allowed_5w_avg, off_rush_yards_tot_home_defense_allowed_5w_avg,
                off_passing_yards_qtr_1_home_defense_allowed_5w_avg, off_passing_yards_qtr_2_home_defense_allowed_5w_avg,
                off_passing_yards_qtr_3_home_defense_allowed_5w_avg, off_passing_yards_qtr_4_home_defense_allowed_5w_avg,
                off_rushing_yards_qtr_1_home_defense_allowed_5w_avg, off_rushing_yards_qtr_2_home_defense_allowed_5w_avg,
                off_rushing_yards_qtr_3_home_defense_allowed_5w_avg, off_rushing_yards_qtr_4_home_defense_allowed_5w_avg,
                away_yac_5w_avg, total_yac_qtr_1_away_5w_avg, total_yac_qtr_2_away_5w_avg, total_yac_qtr_3_away_5w_avg,
                total_yac_qtr_4_away_5w_avg, away_total_plays_5w_avg, total_sacks_away_5w_avg, total_ints_away_5w_avg,
                total_sacks_allow_away_5w_avg, total_ints_throw_away_5w_avg, away_total_time_pos_5w_avg,
                off_pass_yards_tot_away_defense_allowed_5w_avg, off_rush_yards_tot_away_defense_allowed_5w_avg,
                off_passing_yards_qtr_1_away_defense_allowed_5w_avg, off_passing_yards_qtr_2_away_defense_allowed_5w_avg,
                off_passing_yards_qtr_3_away_defense_allowed_5w_avg, off_passing_yards_qtr_4_away_defense_allowed_5w_avg,
                off_rushing_yards_qtr_1_away_defense_allowed_5w_avg, off_rushing_yards_qtr_2_away_defense_allowed_5w_avg,
                off_rushing_yards_qtr_3_away_defense_allowed_5w_avg, off_rushing_yards_qtr_4_away_defense_allowed_5w_avg, 
                total_drives_home_5w_avg, drive_count_qtr_1_home_5w_avg, drive_count_qtr_2_home_5w_avg, drive_count_qtr_3_home_5w_avg,
                drive_count_qtr_4_home_5w_avg, total_drives_away_5w_avg, drive_count_qtr_1_away_5w_avg, drive_count_qtr_2_away_5w_avg, 
                drive_count_qtr_3_away_5w_avg, drive_count_qtr_4_away_5w_avg, 
                total_drives_home_defense_allowed_5w_avg, drive_count_qtr_1_home_defense_allowed_5w_avg,
                drive_count_qtr_2_home_defense_allowed_5w_avg, drive_count_qtr_3_home_defense_allowed_5w_avg,
                drive_count_qtr_4_home_defense_allowed_5w_avg, total_drives_away_defense_allowed_5w_avg,
                drive_count_qtr_1_away_defense_allowed_5w_avg, drive_count_qtr_2_away_defense_allowed_5w_avg,
                drive_count_qtr_3_away_defense_allowed_5w_avg, drive_count_qtr_4_away_defense_allowed_5w_avg, 
                off_pass_yards_drive_avg_home_5w_avg, off_rush_yards_drive_avg_home_5w_avg, off_pass_yds_drive_avg_qtr_1_home_5w_avg,
                off_pass_yds_drive_avg_qtr_2_home_5w_avg, off_pass_yds_drive_avg_qtr_3_home_5w_avg, off_pass_yds_drive_avg_qtr_4_home_5w_avg,
                off_rush_yds_drive_avg_qtr_1_home_5w_avg, off_rush_yds_drive_avg_qtr_2_home_5w_avg, off_rush_yds_drive_avg_qtr_3_home_5w_avg,
                off_rush_yds_drive_avg_qtr_4_home_5w_avg, yac_drive_avg_qtr_1_home_5w_avg, yac_drive_avg_qtr_2_home_5w_avg,
                yac_drive_avg_qtr_3_home_5w_avg, yac_drive_avg_qtr_4_home_5w_avg, avg_sacks_allow_per_drive_home_5w_avg,
                avg_ints_throw_per_drive_home_5w_avg, avg_sacks_per_drive_home_5w_avg, avg_ints_per_drive_home_5w_avg, home_yac_drive_avg_5w_avg,
                home_plays_per_drive_5w_avg, home_avg_drive_time_pos_5w_avg, off_pass_yards_drive_avg_home_defense_allowed_5w_avg,
                off_rush_yards_drive_avg_home_defense_allowed_5w_avg, off_pass_yds_drive_avg_qtr_1_home_defense_allowed_5w_avg,
                off_pass_yds_drive_avg_qtr_2_home_defense_allowed_5w_avg, off_pass_yds_drive_avg_qtr_3_home_defense_allowed_5w_avg,
                off_pass_yds_drive_avg_qtr_4_home_defense_allowed_5w_avg, off_rush_yds_drive_avg_qtr_1_home_defense_allowed_5w_avg,
                off_rush_yds_drive_avg_qtr_2_home_defense_allowed_5w_avg, off_rush_yds_drive_avg_qtr_3_home_defense_allowed_5w_avg,
                off_rush_yds_drive_avg_qtr_4_home_defense_allowed_5w_avg, 
                off_pass_yards_drive_avg_away_5w_avg, off_rush_yards_drive_avg_away_5w_avg, off_pass_yds_drive_avg_qtr_1_away_5w_avg,
                off_pass_yds_drive_avg_qtr_2_away_5w_avg, off_pass_yds_drive_avg_qtr_3_away_5w_avg, off_pass_yds_drive_avg_qtr_4_away_5w_avg,
                off_rush_yds_drive_avg_qtr_1_away_5w_avg, off_rush_yds_drive_avg_qtr_2_away_5w_avg, off_rush_yds_drive_avg_qtr_3_away_5w_avg,
                off_rush_yds_drive_avg_qtr_4_away_5w_avg, yac_drive_avg_qtr_1_away_5w_avg, yac_drive_avg_qtr_2_away_5w_avg,
                yac_drive_avg_qtr_3_away_5w_avg, yac_drive_avg_qtr_4_away_5w_avg, avg_sacks_allow_per_drive_away_5w_avg,
                avg_ints_throw_per_drive_away_5w_avg, avg_sacks_per_drive_away_5w_avg, avg_ints_per_drive_away_5w_avg, away_yac_drive_avg_5w_avg,
                away_plays_per_drive_5w_avg, away_avg_drive_time_pos_5w_avg, off_pass_yards_drive_avg_away_defense_allowed_5w_avg,
                off_rush_yards_drive_avg_away_defense_allowed_5w_avg, off_pass_yds_drive_avg_qtr_1_away_defense_allowed_5w_avg,
                off_pass_yds_drive_avg_qtr_2_away_defense_allowed_5w_avg, off_pass_yds_drive_avg_qtr_3_away_defense_allowed_5w_avg,
                off_pass_yds_drive_avg_qtr_4_away_defense_allowed_5w_avg, off_rush_yds_drive_avg_qtr_1_away_defense_allowed_5w_avg,
                off_rush_yds_drive_avg_qtr_2_away_defense_allowed_5w_avg, off_rush_yds_drive_avg_qtr_3_away_defense_allowed_5w_avg,
                off_rush_yds_drive_avg_qtr_4_away_defense_allowed_5w_avg,
                
                home_score_3w_avg, off_pass_yards_tot_home_3w_avg, off_rush_yards_tot_home_3w_avg, 
                away_score_3w_avg, off_pass_yards_tot_away_3w_avg, off_rush_yards_tot_away_3w_avg, 
                home_point_differential_3w_avg, away_point_differential_3w_avg, 
                off_passing_yards_qtr_1_home_3w_avg, off_passing_yards_qtr_2_home_3w_avg, off_passing_yards_qtr_3_home_3w_avg, 
                off_passing_yards_qtr_4_home_3w_avg, off_rushing_yards_qtr_1_home_3w_avg, 
                off_rushing_yards_qtr_2_home_3w_avg, off_rushing_yards_qtr_3_home_3w_avg, off_rushing_yards_qtr_4_home_3w_avg,
                off_passing_yards_qtr_1_away_3w_avg, off_passing_yards_qtr_2_away_3w_avg, off_passing_yards_qtr_3_away_3w_avg,
                off_passing_yards_qtr_4_away_3w_avg, off_rushing_yards_qtr_1_away_3w_avg, off_rushing_yards_qtr_2_away_3w_avg,
                off_rushing_yards_qtr_3_away_3w_avg, off_rushing_yards_qtr_4_away_3w_avg,
                home_yac_3w_avg, total_yac_qtr_1_home_3w_avg, total_yac_qtr_2_home_3w_avg, total_yac_qtr_3_home_3w_avg,
                total_yac_qtr_4_home_3w_avg, home_total_plays_3w_avg, total_sacks_home_3w_avg, total_ints_home_3w_avg,
                total_sacks_allow_home_3w_avg, total_ints_throw_home_3w_avg, home_total_time_pos_3w_avg,
                off_pass_yards_tot_home_defense_allowed_3w_avg, off_rush_yards_tot_home_defense_allowed_3w_avg,
                off_passing_yards_qtr_1_home_defense_allowed_3w_avg, off_passing_yards_qtr_2_home_defense_allowed_3w_avg,
                off_passing_yards_qtr_3_home_defense_allowed_3w_avg, off_passing_yards_qtr_4_home_defense_allowed_3w_avg,
                off_rushing_yards_qtr_1_home_defense_allowed_3w_avg, off_rushing_yards_qtr_2_home_defense_allowed_3w_avg,
                off_rushing_yards_qtr_3_home_defense_allowed_3w_avg, off_rushing_yards_qtr_4_home_defense_allowed_3w_avg,
                away_yac_3w_avg, total_yac_qtr_1_away_3w_avg, total_yac_qtr_2_away_3w_avg, total_yac_qtr_3_away_3w_avg,
                total_yac_qtr_4_away_3w_avg, away_total_plays_3w_avg, total_sacks_away_3w_avg, total_ints_away_3w_avg,
                total_sacks_allow_away_3w_avg, total_ints_throw_away_3w_avg, away_total_time_pos_3w_avg,
                off_pass_yards_tot_away_defense_allowed_3w_avg, off_rush_yards_tot_away_defense_allowed_3w_avg,
                off_passing_yards_qtr_1_away_defense_allowed_3w_avg, off_passing_yards_qtr_2_away_defense_allowed_3w_avg,
                off_passing_yards_qtr_3_away_defense_allowed_3w_avg, off_passing_yards_qtr_4_away_defense_allowed_3w_avg,
                off_rushing_yards_qtr_1_away_defense_allowed_3w_avg, off_rushing_yards_qtr_2_away_defense_allowed_3w_avg,
                off_rushing_yards_qtr_3_away_defense_allowed_3w_avg, off_rushing_yards_qtr_4_away_defense_allowed_3w_avg, 
                total_drives_home_3w_avg, drive_count_qtr_1_home_3w_avg, drive_count_qtr_2_home_3w_avg, drive_count_qtr_3_home_3w_avg,
                drive_count_qtr_4_home_3w_avg, total_drives_away_3w_avg, drive_count_qtr_1_away_3w_avg, drive_count_qtr_2_away_3w_avg, 
                drive_count_qtr_3_away_3w_avg, drive_count_qtr_4_away_3w_avg, 
                total_drives_home_defense_allowed_3w_avg, drive_count_qtr_1_home_defense_allowed_3w_avg,
                drive_count_qtr_2_home_defense_allowed_3w_avg, drive_count_qtr_3_home_defense_allowed_3w_avg,
                drive_count_qtr_4_home_defense_allowed_3w_avg, total_drives_away_defense_allowed_3w_avg,
                drive_count_qtr_1_away_defense_allowed_3w_avg, drive_count_qtr_2_away_defense_allowed_3w_avg,
                drive_count_qtr_3_away_defense_allowed_3w_avg, drive_count_qtr_4_away_defense_allowed_3w_avg, 
                off_pass_yards_drive_avg_home_3w_avg, off_rush_yards_drive_avg_home_3w_avg, off_pass_yds_drive_avg_qtr_1_home_3w_avg,
                off_pass_yds_drive_avg_qtr_2_home_3w_avg, off_pass_yds_drive_avg_qtr_3_home_3w_avg, off_pass_yds_drive_avg_qtr_4_home_3w_avg,
                off_rush_yds_drive_avg_qtr_1_home_3w_avg, off_rush_yds_drive_avg_qtr_2_home_3w_avg, off_rush_yds_drive_avg_qtr_3_home_3w_avg,
                off_rush_yds_drive_avg_qtr_4_home_3w_avg, yac_drive_avg_qtr_1_home_3w_avg, yac_drive_avg_qtr_2_home_3w_avg,
                yac_drive_avg_qtr_3_home_3w_avg, yac_drive_avg_qtr_4_home_3w_avg, avg_sacks_allow_per_drive_home_3w_avg,
                avg_ints_throw_per_drive_home_3w_avg, avg_sacks_per_drive_home_3w_avg, avg_ints_per_drive_home_3w_avg, home_yac_drive_avg_3w_avg,
                home_plays_per_drive_3w_avg, home_avg_drive_time_pos_3w_avg, off_pass_yards_drive_avg_home_defense_allowed_3w_avg,
                off_rush_yards_drive_avg_home_defense_allowed_3w_avg, off_pass_yds_drive_avg_qtr_1_home_defense_allowed_3w_avg,
                off_pass_yds_drive_avg_qtr_2_home_defense_allowed_3w_avg, off_pass_yds_drive_avg_qtr_3_home_defense_allowed_3w_avg,
                off_pass_yds_drive_avg_qtr_4_home_defense_allowed_3w_avg, off_rush_yds_drive_avg_qtr_1_home_defense_allowed_3w_avg,
                off_rush_yds_drive_avg_qtr_2_home_defense_allowed_3w_avg, off_rush_yds_drive_avg_qtr_3_home_defense_allowed_3w_avg,
                off_rush_yds_drive_avg_qtr_4_home_defense_allowed_3w_avg, 
                off_pass_yards_drive_avg_away_3w_avg, off_rush_yards_drive_avg_away_3w_avg, off_pass_yds_drive_avg_qtr_1_away_3w_avg,
                off_pass_yds_drive_avg_qtr_2_away_3w_avg, off_pass_yds_drive_avg_qtr_3_away_3w_avg, off_pass_yds_drive_avg_qtr_4_away_3w_avg,
                off_rush_yds_drive_avg_qtr_1_away_3w_avg, off_rush_yds_drive_avg_qtr_2_away_3w_avg, off_rush_yds_drive_avg_qtr_3_away_3w_avg,
                off_rush_yds_drive_avg_qtr_4_away_3w_avg, yac_drive_avg_qtr_1_away_3w_avg, yac_drive_avg_qtr_2_away_3w_avg,
                yac_drive_avg_qtr_3_away_3w_avg, yac_drive_avg_qtr_4_away_3w_avg, avg_sacks_allow_per_drive_away_3w_avg,
                avg_ints_throw_per_drive_away_3w_avg, avg_sacks_per_drive_away_3w_avg, avg_ints_per_drive_away_3w_avg, away_yac_drive_avg_3w_avg,
                away_plays_per_drive_3w_avg, away_avg_drive_time_pos_3w_avg, off_pass_yards_drive_avg_away_defense_allowed_3w_avg,
                off_rush_yards_drive_avg_away_defense_allowed_3w_avg, off_pass_yds_drive_avg_qtr_1_away_defense_allowed_3w_avg,
                off_pass_yds_drive_avg_qtr_2_away_defense_allowed_3w_avg, off_pass_yds_drive_avg_qtr_3_away_defense_allowed_3w_avg,
                off_pass_yds_drive_avg_qtr_4_away_defense_allowed_3w_avg, off_rush_yds_drive_avg_qtr_1_away_defense_allowed_3w_avg,
                off_rush_yds_drive_avg_qtr_2_away_defense_allowed_3w_avg, off_rush_yds_drive_avg_qtr_3_away_defense_allowed_3w_avg,
                off_rush_yds_drive_avg_qtr_4_away_defense_allowed_3w_avg, 
                
                home_score_3w_avg_RATIO_home_score_5w_avg, off_pass_yards_tot_home_3w_avg_RATIO_off_pass_yards_tot_home_5w_avg, 
                off_rush_yards_tot_home_3w_avg_RATIO_off_rush_yards_tot_home_5w_avg, 
                off_passing_yards_qtr_1_home_3w_avg_RATIO_off_passing_yards_qtr_1_home_5w_avg, 
                off_passing_yards_qtr_2_home_3w_avg_RATIO_off_passing_yards_qtr_2_home_5w_avg, 
                off_passing_yards_qtr_3_home_3w_avg_RATIO_off_passing_yards_qtr_3_home_5w_avg, 
                off_passing_yards_qtr_4_home_3w_avg_RATIO_off_passing_yards_qtr_4_home_5w_avg, 
                off_rushing_yards_qtr_1_home_3w_avg_RATIO_off_rushing_yards_qtr_1_home_5w_avg, 
                off_rushing_yards_qtr_2_home_3w_avg_RATIO_off_rushing_yards_qtr_2_home_5w_avg, 
                off_rushing_yards_qtr_3_home_3w_avg_RATIO_off_rushing_yards_qtr_3_home_5w_avg, 
                off_rushing_yards_qtr_4_home_3w_avg_RATIO_off_rushing_yards_qtr_4_home_5w_avg, 
                home_yac_3w_avg_RATIO_home_yac_5w_avg, total_yac_qtr_1_home_3w_avg_RATIO_total_yac_qtr_1_home_5w_avg, 
                total_yac_qtr_2_home_3w_avg_RATIO_total_yac_qtr_2_home_5w_avg, 
                total_yac_qtr_3_home_3w_avg_RATIO_total_yac_qtr_3_home_5w_avg, 
                total_yac_qtr_4_home_3w_avg_RATIO_total_yac_qtr_4_home_5w_avg, 
                home_total_plays_3w_avg_RATIO_home_total_plays_5w_avg, total_sacks_home_3w_avg_RATIO_total_sacks_home_5w_avg, 
                total_ints_home_3w_avg_RATIO_total_ints_home_5w_avg, total_sacks_allow_home_3w_avg_RATIO_total_sacks_allow_home_5w_avg, 
                total_ints_throw_home_3w_avg_RATIO_total_ints_throw_home_5w_avg, 
                home_total_time_pos_3w_avg_RATIO_home_total_time_pos_5w_avg, 
                total_drives_home_3w_avg_RATIO_total_drives_home_5w_avg, drive_count_qtr_1_home_3w_avg_RATIO_drive_count_qtr_1_home_5w_avg, 
                drive_count_qtr_2_home_3w_avg_RATIO_drive_count_qtr_2_home_5w_avg, 
                drive_count_qtr_3_home_3w_avg_RATIO_drive_count_qtr_3_home_5w_avg, 
                drive_count_qtr_4_home_3w_avg_RATIO_drive_count_qtr_4_home_5w_avg, 
                off_pass_yards_tot_home_defense_allowed_3w_avg_RATIO_off_pass_yards_tot_home_defense_allowed_5w_avg, 
                off_rush_yards_tot_home_defense_allowed_3w_avg_RATIO_off_rush_yards_tot_home_defense_allowed_5w_avg, 
                off_passing_yards_qtr_1_home_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_1_home_defense_allowed_5w_avg, 
                off_passing_yards_qtr_2_home_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_2_home_defense_allowed_5w_avg, 
                off_passing_yards_qtr_3_home_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_3_home_defense_allowed_5w_avg, 
                off_passing_yards_qtr_4_home_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_4_home_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_1_home_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_1_home_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_2_home_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_2_home_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_3_home_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_3_home_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_4_home_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_4_home_defense_allowed_5w_avg, 
                total_drives_home_defense_allowed_3w_avg_RATIO_total_drives_home_defense_allowed_5w_avg, 
                drive_count_qtr_1_home_defense_allowed_3w_avg_RATIO_drive_count_qtr_1_home_defense_allowed_5w_avg, 
                drive_count_qtr_2_home_defense_allowed_3w_avg_RATIO_drive_count_qtr_2_home_defense_allowed_5w_avg, 
                drive_count_qtr_3_home_defense_allowed_3w_avg_RATIO_drive_count_qtr_3_home_defense_allowed_5w_avg, 
                drive_count_qtr_4_home_defense_allowed_3w_avg_RATIO_drive_count_qtr_4_home_defense_allowed_5w_avg, 
                away_score_3w_avg_RATIO_away_score_5w_avg, off_pass_yards_tot_away_3w_avg_RATIO_off_pass_yards_tot_away_5w_avg, 
                off_rush_yards_tot_away_3w_avg_RATIO_off_rush_yards_tot_away_5w_avg, 
                off_passing_yards_qtr_1_away_3w_avg_RATIO_off_passing_yards_qtr_1_away_5w_avg, 
                off_passing_yards_qtr_2_away_3w_avg_RATIO_off_passing_yards_qtr_2_away_5w_avg, 
                off_passing_yards_qtr_3_away_3w_avg_RATIO_off_passing_yards_qtr_3_away_5w_avg, 
                off_passing_yards_qtr_4_away_3w_avg_RATIO_off_passing_yards_qtr_4_away_5w_avg, 
                off_rushing_yards_qtr_1_away_3w_avg_RATIO_off_rushing_yards_qtr_1_away_5w_avg, 
                off_rushing_yards_qtr_2_away_3w_avg_RATIO_off_rushing_yards_qtr_2_away_5w_avg, 
                off_rushing_yards_qtr_3_away_3w_avg_RATIO_off_rushing_yards_qtr_3_away_5w_avg, 
                off_rushing_yards_qtr_4_away_3w_avg_RATIO_off_rushing_yards_qtr_4_away_5w_avg, 
                away_yac_3w_avg_RATIO_away_yac_5w_avg, total_yac_qtr_1_away_3w_avg_RATIO_total_yac_qtr_1_away_5w_avg, 
                total_yac_qtr_2_away_3w_avg_RATIO_total_yac_qtr_2_away_5w_avg, 
                total_yac_qtr_3_away_3w_avg_RATIO_total_yac_qtr_3_away_5w_avg, 
                total_yac_qtr_4_away_3w_avg_RATIO_total_yac_qtr_4_away_5w_avg, 
                away_total_plays_3w_avg_RATIO_away_total_plays_5w_avg, total_sacks_away_3w_avg_RATIO_total_sacks_away_5w_avg, 
                total_ints_away_3w_avg_RATIO_total_ints_away_5w_avg, total_sacks_allow_away_3w_avg_RATIO_total_sacks_allow_away_5w_avg, 
                total_ints_throw_away_3w_avg_RATIO_total_ints_throw_away_5w_avg, 
                away_total_time_pos_3w_avg_RATIO_away_total_time_pos_5w_avg, 
                total_drives_away_3w_avg_RATIO_total_drives_away_5w_avg, drive_count_qtr_1_away_3w_avg_RATIO_drive_count_qtr_1_away_5w_avg, 
                drive_count_qtr_2_away_3w_avg_RATIO_drive_count_qtr_2_away_5w_avg, 
                drive_count_qtr_3_away_3w_avg_RATIO_drive_count_qtr_3_away_5w_avg, 
                drive_count_qtr_4_away_3w_avg_RATIO_drive_count_qtr_4_away_5w_avg, 
                off_pass_yards_tot_away_defense_allowed_3w_avg_RATIO_off_pass_yards_tot_away_defense_allowed_5w_avg, 
                off_rush_yards_tot_away_defense_allowed_3w_avg_RATIO_off_rush_yards_tot_away_defense_allowed_5w_avg, 
                off_passing_yards_qtr_1_away_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_1_away_defense_allowed_5w_avg, 
                off_passing_yards_qtr_2_away_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_2_away_defense_allowed_5w_avg, 
                off_passing_yards_qtr_3_away_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_3_away_defense_allowed_5w_avg, 
                off_passing_yards_qtr_4_away_defense_allowed_3w_avg_RATIO_off_passing_yards_qtr_4_away_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_1_away_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_1_away_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_2_away_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_2_away_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_3_away_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_3_away_defense_allowed_5w_avg, 
                off_rushing_yards_qtr_4_away_defense_allowed_3w_avg_RATIO_off_rushing_yards_qtr_4_away_defense_allowed_5w_avg, 
                total_drives_away_defense_allowed_3w_avg_RATIO_total_drives_away_defense_allowed_5w_avg, 
                drive_count_qtr_1_away_defense_allowed_3w_avg_RATIO_drive_count_qtr_1_away_defense_allowed_5w_avg, 
                drive_count_qtr_2_away_defense_allowed_3w_avg_RATIO_drive_count_qtr_2_away_defense_allowed_5w_avg, 
                drive_count_qtr_3_away_defense_allowed_3w_avg_RATIO_drive_count_qtr_3_away_defense_allowed_5w_avg, 
                drive_count_qtr_4_away_defense_allowed_3w_avg_RATIO_drive_count_qtr_4_away_defense_allowed_5w_avg, 
                off_pass_yards_drive_avg_home_3w_avg_RATIO_off_pass_yards_drive_avg_home_5w_avg, 
                off_rush_yards_drive_avg_home_3w_avg_RATIO_off_rush_yards_drive_avg_home_5w_avg, 
                off_pass_yds_drive_avg_qtr_1_home_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_1_home_5w_avg, 
                off_pass_yds_drive_avg_qtr_2_home_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_2_home_5w_avg, 
                off_pass_yds_drive_avg_qtr_3_home_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_3_home_5w_avg, 
                off_pass_yds_drive_avg_qtr_4_home_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_4_home_5w_avg, 
                off_rush_yds_drive_avg_qtr_1_home_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_1_home_5w_avg, 
                off_rush_yds_drive_avg_qtr_2_home_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_2_home_5w_avg, 
                off_rush_yds_drive_avg_qtr_3_home_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_3_home_5w_avg, 
                off_rush_yds_drive_avg_qtr_4_home_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_4_home_5w_avg, 
                yac_drive_avg_qtr_1_home_3w_avg_RATIO_yac_drive_avg_qtr_1_home_5w_avg, 
                yac_drive_avg_qtr_2_home_3w_avg_RATIO_yac_drive_avg_qtr_2_home_5w_avg, 
                yac_drive_avg_qtr_3_home_3w_avg_RATIO_yac_drive_avg_qtr_3_home_5w_avg, 
                yac_drive_avg_qtr_4_home_3w_avg_RATIO_yac_drive_avg_qtr_4_home_5w_avg, 
                avg_sacks_allow_per_drive_home_3w_avg_RATIO_avg_sacks_allow_per_drive_home_5w_avg, 
                avg_ints_throw_per_drive_home_3w_avg_RATIO_avg_ints_throw_per_drive_home_5w_avg, 
                avg_sacks_per_drive_home_3w_avg_RATIO_avg_sacks_per_drive_home_5w_avg, 
                avg_ints_per_drive_home_3w_avg_RATIO_avg_ints_per_drive_home_5w_avg, 
                home_yac_drive_avg_3w_avg_RATIO_home_yac_drive_avg_5w_avg, 
                home_plays_per_drive_3w_avg_RATIO_home_plays_per_drive_5w_avg, 
                home_avg_drive_time_pos_3w_avg_RATIO_home_avg_drive_time_pos_5w_avg, 
                off_pass_yards_drive_avg_home_defense_allowed_3w_avg_RATIO_off_pass_yards_drive_avg_home_defense_allowed_5w_avg, 
                off_rush_yards_drive_avg_home_defense_allowed_3w_avg_RATIO_off_rush_yards_drive_avg_home_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_1_home_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_1_home_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_2_home_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_2_home_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_3_home_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_3_home_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_4_home_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_4_home_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_1_home_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_1_home_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_2_home_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_2_home_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_3_home_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_3_home_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_4_home_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_4_home_defense_allowed_5w_avg, 
                off_pass_yards_drive_avg_away_3w_avg_RATIO_off_pass_yards_drive_avg_away_5w_avg, 
                off_rush_yards_drive_avg_away_3w_avg_RATIO_off_rush_yards_drive_avg_away_5w_avg, 
                off_pass_yds_drive_avg_qtr_1_away_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_1_away_5w_avg, 
                off_pass_yds_drive_avg_qtr_2_away_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_2_away_5w_avg, 
                off_pass_yds_drive_avg_qtr_3_away_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_3_away_5w_avg, 
                off_pass_yds_drive_avg_qtr_4_away_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_4_away_5w_avg, 
                off_rush_yds_drive_avg_qtr_1_away_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_1_away_5w_avg, 
                off_rush_yds_drive_avg_qtr_2_away_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_2_away_5w_avg, 
                off_rush_yds_drive_avg_qtr_3_away_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_3_away_5w_avg, 
                off_rush_yds_drive_avg_qtr_4_away_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_4_away_5w_avg, 
                yac_drive_avg_qtr_1_away_3w_avg_RATIO_yac_drive_avg_qtr_1_away_5w_avg, 
                yac_drive_avg_qtr_2_away_3w_avg_RATIO_yac_drive_avg_qtr_2_away_5w_avg, 
                yac_drive_avg_qtr_3_away_3w_avg_RATIO_yac_drive_avg_qtr_3_away_5w_avg, 
                yac_drive_avg_qtr_4_away_3w_avg_RATIO_yac_drive_avg_qtr_4_away_5w_avg, 
                avg_sacks_allow_per_drive_away_3w_avg_RATIO_avg_sacks_allow_per_drive_away_5w_avg, 
                avg_ints_throw_per_drive_away_3w_avg_RATIO_avg_ints_throw_per_drive_away_5w_avg, 
                avg_sacks_per_drive_away_3w_avg_RATIO_avg_sacks_per_drive_away_5w_avg, 
                avg_ints_per_drive_away_3w_avg_RATIO_avg_ints_per_drive_away_5w_avg, 
                away_yac_drive_avg_3w_avg_RATIO_away_yac_drive_avg_5w_avg, 
                away_plays_per_drive_3w_avg_RATIO_away_plays_per_drive_5w_avg, 
                away_avg_drive_time_pos_3w_avg_RATIO_away_avg_drive_time_pos_5w_avg, 
                off_pass_yards_drive_avg_away_defense_allowed_3w_avg_RATIO_off_pass_yards_drive_avg_away_defense_allowed_5w_avg, 
                off_rush_yards_drive_avg_away_defense_allowed_3w_avg_RATIO_off_rush_yards_drive_avg_away_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_1_away_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_1_away_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_2_away_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_2_away_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_3_away_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_3_away_defense_allowed_5w_avg, 
                off_pass_yds_drive_avg_qtr_4_away_defense_allowed_3w_avg_RATIO_off_pass_yds_drive_avg_qtr_4_away_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_1_away_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_1_away_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_2_away_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_2_away_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_3_away_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_3_away_defense_allowed_5w_avg, 
                off_rush_yds_drive_avg_qtr_4_away_defense_allowed_3w_avg_RATIO_off_rush_yds_drive_avg_qtr_4_away_defense_allowed_5w_avg)%>%
  dplyr::collect()
```

#### Dummies

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_big_data_use <- dummy_cols(model_big_data_use, select_columns = c("home_coach", "away_coach", "roof", "surface", "start_time"))
```

#### Split data into training and testing

```{r}
train_big <- filter(model_big_data_use, season %in% seq(1999, 2018))
test_big <- filter(setdiff(model_big_data_use, train_big), season %in% c(2019, 2021))
```

### Convert data to DMatrix

```{r}
dtrain_big <- xgb.DMatrix(data = as.matrix(train_big[, -c(1,4:8)]), label = train_big$point_differential)
dtest_big <- xgb.DMatrix(data = as.matrix(test_big[, -c(1, 4:8)]), label = test_big$point_differential)
```

### XGBoost Model

#### Train Model

```{r}
set.seed(111111)
tic()
model_big <- xgboost(data = dtrain_big, #set training data
                      nrounds = 100, #set number of rounds
                      tree_method = "hist",
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
toc()
```

#### Variable Importance

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_big)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)
```
#### Test Model

```{r}
library(Metrics)

big_model_preds <- predict(model_big, dtest_big)

rmse(test_big$point_differential, big_model_preds)
```

#### Plot Actual vs Predicted

```{r}
par(pty = "s")
plot(test_big$point_differential, big_model_preds, asp = 1)
abline(a = 0, b = 1)
```

# Tune Model

```{r}
set.seed(111111)
tic()
big_tune_1 <- xgb.cv(data = dtrain_big, #set training data
                      nfold = 5,
                      eta = 0.1,
                      nrounds = 1000, #set number of rounds
                      early_stopping_rounds = 50,
                      tree_method = "hist",
                      verbose = 1, #prints out fit
                      print_every_n = 20, #prints out result every 20th iteration
                      eval_metric = "rmse")
toc()
```

```{r}
max_depth_vals <- c(3, 5, 7, 10, 15) # Create vector of max depth values
min_child_weight <- c(1,3,5,7, 10, 15) # Create vector of min child values
gamma_vals <- c(0, 0.05, 0.1, 0.15, 0.2) # Create vector of gamma values
subsample <- c(0.6, 0.7, 0.8, 0.9, 1) # Create vector of subsample values
colsample_by_tree <- c(0.6, 0.7, 0.8, 0.9, 1) # Create vector of col sample values
```

Referenced this for tuning method: https://www.r-bloggers.com/2021/01/bayesian-model-based-optimization-in-r/

```{r}
library(mlrMBO)
library(ParamHelpers)
library(DiceKriging)
library(smoof)
```

```{r}
obj.fun <- makeSingleObjectiveFunction(
  name = "xgb_cv_bayes",
  fn =   function(x){
    set.seed(123456)
    cv <- xgb.cv(params = list(
      booster          = "gbtree",
      eta              = x["eta"],
      max_depth        = x["max_depth"],
      min_child_weight = x["min_child_weight"],
      gamma            = x["gamma"],
      subsample        = x["subsample"],
      colsample_bytree = x["colsample_bytree"],
      max_delta_step   = x["max_delta_step"], #add lambda and alpha
      objective        = 'reg:squarederror', 
      eval_metric     = 'rmse'),
      data = dtrain_big, ## must set in global.Env()
      nround = 1000, ## Set this large and use early stopping
      nthread = 10, ## Adjust based on your machine
      nfold =  5,
      prediction = FALSE,
      showsd = TRUE,
      early_stopping_rounds = 25, ## If evaluation metric does not improve on out-of-fold sample for 25 rounds, stop #change this to 50
      verbose = 1,
      print_every_n = 20)

    cv$evaluation_log %>% pull(4) %>% min  ## column 4 is the eval metric here, rmse
  },
  par.set = makeParamSet(
    makeNumericParam("eta",                    lower = 0.005, upper = 0.01), #make eta higher .3
    makeNumericParam("gamma",                  lower = 0,     upper = 0.2),
    makeIntegerParam("max_depth",              lower= 2,      upper = 15),
    makeIntegerParam("min_child_weight",       lower= 1,    upper = 15),
    makeNumericParam("subsample",              lower = 0.20,  upper = 1),
    makeNumericParam("colsample_bytree",       lower = 0.20,  upper = 1), #bring min colsample up
    makeNumericParam("max_delta_step",         lower = 0,     upper = 10)
  ), #try lambda and alpha 1-10, 0-10
  minimize = TRUE ## rmse
)
```

```{r}
do_bayes <- function(n_design = NULL, opt_steps = NULL, of = obj.fun, seed = 123456) {
  set.seed(seed)

  des <- generateDesign(n=n_design,
                        par.set = getParamSet(of),
                        fun = lhs::randomLHS)

  control <- makeMBOControl() %>%
    setMBOControlTermination(., iters = opt_steps)

  ## kriging with a matern(3,2) covariance function is the default surrogate model for numerical domains
  ## but if you wanted to override this you could modify the makeLearner() call below to define your own
  ## GP surrogate model with more or lesss smoothness, or use an entirely different method
  run <- mbo(fun = of,
             design = des,
             learner = makeLearner("regr.km", predict.type = "se", covtype = "matern3_2", control = list(trace = FALSE)),
             control = control, 
             show.info = TRUE)

  opt_plot <- run$opt.path$env$path %>%
    mutate(Round = row_number())# %>%
    #mutate(type = case_when(Round
}
```

```{r}
library(kableExtra)
des <- generateDesign(n=45,
                      par.set = getParamSet(obj.fun),
                      fun = lhs::randomLHS)

kable(des, format = "html", digits = 4) %>% 
  kable_styling(font_size = 10) %>%
  kable_material_dark()
```

```{r}
library(scatterplot3d)
scatterplot3d(des$eta, des$gamma, des$min_child_weight,
              type = "h", color = "blue", pch = 16)
```

```{r}
des <- generateDesign(n=30,
                      par.set = getParamSet(obj.fun),
                      fun = lhs::randomLHS)
scatterplot3d(des$eta, des$gamma, des$min_child_weight,
              type = "h", color = "blue", pch = 16)
```

```{r}
#dm <- fre_dm
tic()
runs <- do_bayes(n_design = 30, of = obj.fun, opt_steps = 10, seed = 123456)
toc()
```

mbo] 10: eta=0.00998; gamma=0.15; max_depth=7; min_child_weight=11; subsample=0.202; colsample_bytree=0.92; max_delta_step=9.13 : y = 10.5 : 646.5 secs : infill_cb
> toc()
35111.294 sec elapsed

# Tuned Model

```{r}
set.seed(123456)
tic()
model_tuned <- xgboost(data = dtrain_big, #set training data
                      nrounds = 1000, #set number of rounds
                      tree_method = "hist",
                      
                      eta = 0.00998,
                      gamma = 0.15,
                      max_depth = 7,
                      min_child_weight = 11,
                      subsample = 0.202,
                      colsample_bytree = 0.92,
                      max_delta_step = 9.13,
                      
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
toc()
```

```{r}
#Variable Importance
# Extract importance
imp_mat <- xgb.importance(model = model_tuned)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 40)
```


```{r}
library(Metrics)

model_tuned_preds <- predict(model_tuned, dtest_big)

rmse(test_big$point_differential, model_tuned_preds)
```



```{r}
#Plot Actual vs Predicted
par(pty = "s")
plot(test_big$point_differential, model_tuned_preds, asp = 1)
abline(a = 0, b = 1)
```

# Disconeect from DB
```{r}
DBI::dbDisconnect(connection) #disconnect from database
```

