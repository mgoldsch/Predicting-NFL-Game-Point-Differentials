---
title: "model"
author: "Michael Goldschlager"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set Up

### Packages

```{r, echo = FALSE}
library(tidyverse) #dplyr functions mainly
library(DBI) #database
library(RSQLite) #database
library(tictoc) #timing code execution

library(xgboost) # Load XGBoost
library(caret) # Load Caret
library(OptimalCutpoints) # Load optimal cutpoints
library(ggplot2) # Load ggplot2
library(xgboostExplainer) # Load XGboost Explainer
library(pROC) # Load proc
library(SHAPforxgboost) # Load shap for XGBoost
```

### Set Working Directory

```{r}
#wd <- dirname(sys.frame(1)$ofile) #gets the directory where this script is located
#setwd(wd) #sets the working directory to the directory of this script, this is so relative paths can be used below
```

### Connect to Database

```{r}
connection <- DBI::dbConnect(RSQLite::SQLite(), "./data/pbp_db") #create connection for db
```

### Get nfl_data_set table from the database
```{r}
nfl_data_set <- dplyr::tbl(connection, "nfl_data_set") #get the nfl_data_set table from the db
```

# Data Preparation

### Select rows and columns from nfl_data_set we want for the model

```{r}
model_basic_data_use <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, 
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

### Split data into training and testing

```{r}
train_basic <- model_basic_data_use[model_basic_data_use$season %in% c(2018, 2019, 2020), ]
test_basic <- setdiff(model_basic_data_use, train_basic)
```

### Convert data to DMatrix

```{r}
dtrain_basic <- xgb.DMatrix(data = as.matrix(train_basic[, -1]), label = train_basic$point_differential)
dtest_basic <- xgb.DMatrix(data = as.matrix(test_basic[, -1]), label = test_basic$point_differential)
```

# XGBoost Model

### Train Model

```{r}
set.seed(111111)
model_basic <- xgboost(data = dtrain_basic, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

### Variable Importance

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_basic)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 10)
```
### Test Model

```{r}
library(Metrics)

basic_model_preds <- predict(model_basic, dtest_basic)

rmse(test_basic$point_differential, basic_model_preds)
```

# Introduce more variables

### Coaches

```{r}
#get data
model_2_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, home_coach, away_coach,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_2_data <- dummy_cols(model_2_data, select_columns = c("home_coach", "away_coach"))
```

```{r}
#Split data into train and test
train_2 <- model_2_data[model_2_data$season %in% c(2018, 2019, 2020), ]
test_2 <- setdiff(model_2_data, train_2)
```

```{r}
#Convert data to DMatrix
dtrain_2 <- xgb.DMatrix(data = as.matrix(train_2[, -c(1,4,5)]), label = train_2$point_differential)
dtest_2 <- xgb.DMatrix(data = as.matrix(test_2[, -c(1,4,5)]), label = test_2$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_2 <- xgboost(data = dtrain_2, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_2)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_2_preds <- predict(model_2, dtest_2)

rmse(test_2$point_differential, model_2_preds)
```
  
May be worth adding the Sith Lord...

### Adding just Bill Belichick

```{r}
#get data
model_bb_data <- model_2_data[, c(1:3, 6:13)]
model_bb_data <- cbind(model_bb_data, model_2_data[, "away_coach_Bill Belichick"])
```

```{r}
#Split data into train and test
train_bb <- model_bb_data[model_bb_data$season %in% c(2018, 2019, 2020), ]
test_bb <- setdiff(model_bb_data, train_bb)
```

```{r}
#Convert data to DMatrix
dtrain_bb <- xgb.DMatrix(data = as.matrix(train_bb[, -1]), label = train_bb$point_differential)
dtest_bb <- xgb.DMatrix(data = as.matrix(test_bb[, -1]), label = test_bb$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_bb <- xgboost(data = dtrain_bb, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_bb)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_bb_preds <- predict(model_bb, dtest_bb)

rmse(test_bb$point_differential, model_bb_preds)
```

The Sith Lord does not improve model performance. Do not include

### Roof

```{r}
#get data
model_3_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, roof,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_3_data <- dummy_cols(model_3_data, select_columns = "roof")
```

```{r}
#Split data into train and test
train_3 <- model_3_data[model_3_data$season %in% c(2018, 2019, 2020), ]
test_3 <- setdiff(model_3_data, train_3)
```

```{r}
#Convert data to DMatrix
dtrain_3 <- xgb.DMatrix(data = as.matrix(train_3[, -c(1,4)]), label = train_3$point_differential)
dtest_3 <- xgb.DMatrix(data = as.matrix(test_3[, -c(1,4)]), label = test_3$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_3 <- xgboost(data = dtrain_3, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_3)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_3_preds <- predict(model_3, dtest_3)

rmse(test_3$point_differential, model_3_preds)
```

Worse than original. Don't add

### Surface

```{r}
#get data
model_4_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, surface,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_4_data <- dummy_cols(model_4_data, select_columns = "surface")
```

```{r}
#Split data into train and test
train_4 <- model_4_data[model_4_data$season %in% c(2018, 2019, 2020), ]
test_4 <- setdiff(model_4_data, train_4)
```

```{r}
#Convert data to DMatrix
dtrain_4 <- xgb.DMatrix(data = as.matrix(train_4[, -c(1,4)]), label = train_4$point_differential)
dtest_4 <- xgb.DMatrix(data = as.matrix(test_4[, -c(1,4)]), label = test_4$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_4 <- xgboost(data = dtrain_4, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_4)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_4_preds <- predict(model_4, dtest_4)

rmse(test_4$point_differential, model_4_preds)
```

Even fieldturf probably isn't important enough

### Pass and Rush yard quarter breakdowns

```{r}
#get data
model_5_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg, 
                off_passing_yards_qtr_1_home_5w_avg, off_passing_yards_qtr_2_home_5w_avg, off_passing_yards_qtr_3_home_5w_avg, 
                off_passing_yards_qtr_4_home_5w_avg, off_rushing_yards_qtr_1_home_5w_avg, 
                off_rushing_yards_qtr_2_home_5w_avg, off_rushing_yards_qtr_3_home_5w_avg, off_rushing_yards_qtr_4_home_5w_avg, 
                off_passing_yards_qtr_1_away_5w_avg, off_passing_yards_qtr_2_away_5w_avg, off_passing_yards_qtr_3_away_5w_avg, 
                off_passing_yards_qtr_4_away_5w_avg, off_rushing_yards_qtr_1_away_5w_avg, 
                off_rushing_yards_qtr_2_away_5w_avg, off_rushing_yards_qtr_3_away_5w_avg, off_rushing_yards_qtr_4_away_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#Split data into train and test
train_5 <- model_5_data[model_5_data$season %in% c(2018, 2019, 2020), ]
test_5 <- setdiff(model_5_data, train_5)
```

```{r}
#Convert data to DMatrix
dtrain_5 <- xgb.DMatrix(data = as.matrix(train_5[, -1]), label = train_5$point_differential)
dtest_5 <- xgb.DMatrix(data = as.matrix(test_5[, -1]), label = test_5$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_5 <- xgboost(data = dtrain_5, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_5)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_5_preds <- predict(model_5, dtest_5)

rmse(test_5$point_differential, model_5_preds)
```

### Start Time

```{r}
#get data
model_6_data <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, start_time,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg) %>% 
  dplyr::collect()
```

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_6_data <- dummy_cols(model_6_data, select_columns = "start_time")
```

```{r}
#Split data into train and test
train_6 <- model_6_data[model_6_data$season %in% c(2018, 2019, 2020), ]
test_6 <- setdiff(model_6_data, train_6)
```

```{r}
#Convert data to DMatrix
dtrain_6 <- xgb.DMatrix(data = as.matrix(train_6[, -c(1,4)]), label = train_6$point_differential)
dtest_6 <- xgb.DMatrix(data = as.matrix(test_6[, -c(1,4)]), label = test_6$point_differential)
```

```{r}
#Train model
set.seed(111111)
model_6 <- xgboost(data = dtrain_6, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_6)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)

```

```{r}
#Test model
library(Metrics)

model_6_preds <- predict(model_6, dtest_6)

rmse(test_6$point_differential, model_6_preds)
```

Probably not worth including

Actually, after talking to Martin I can just throw in all the variaables and XGBoost will drop ones that aren't useful. Can explore lambda values for penalization.

# Big Model

### Data Preparation

#### Select rows and columns from nfl_data_set we want for the model

```{r}
model_big_data_use <- nfl_data_set %>% 
  dplyr::filter(season %in% c(2021, 2020, 2019, 2018) & season_type == "REG") %>% 
  dplyr::select(point_differential, season, week, home_coach, away_coach, roof, surface, start_time,
                home_score_5w_avg, off_pass_yards_tot_home_5w_avg, off_rush_yards_tot_home_5w_avg, 
                away_score_5w_avg, off_pass_yards_tot_away_5w_avg, off_rush_yards_tot_away_5w_avg, 
                home_point_differential_5w_avg, away_point_differential_5w_avg, 
                off_passing_yards_qtr_1_home_5w_avg, off_passing_yards_qtr_2_home_5w_avg, off_passing_yards_qtr_3_home_5w_avg, 
                off_passing_yards_qtr_4_home_5w_avg, off_rushing_yards_qtr_1_home_5w_avg, 
                off_rushing_yards_qtr_2_home_5w_avg, off_rushing_yards_qtr_3_home_5w_avg, off_rushing_yards_qtr_4_home_5w_avg,
                off_passing_yards_qtr_1_away_5w_avg, off_passing_yards_qtr_2_away_5w_avg, off_passing_yards_qtr_3_away_5w_avg,
                off_passing_yards_qtr_4_away_5w_avg, off_rushing_yards_qtr_1_away_5w_avg, off_rushing_yards_qtr_2_away_5w_avg,
                off_rushing_yards_qtr_3_away_5w_avg, off_rushing_yards_qtr_4_away_5w_avg, 
                off_pass_yards_tot_home_defense_allowed, off_rush_yards_tot_home_defense_allowed, off_passing_yards_qtr_1_home_defense_allowed,
                off_passing_yards_qtr_2_home_defense_allowed,off_passing_yards_qtr_3_home_defense_allowed,
                off_passing_yards_qtr_4_home_defense_allowed,off_rushing_yards_qtr_1_home_defense_allowed,
                off_rushing_yards_qtr_2_home_defense_allowed, off_rushing_yards_qtr_3_home_defense_allowed,
                off_rushing_yards_qtr_4_home_defense_allowed, 
                off_pass_yards_tot_away_defense_allowed, off_rush_yards_tot_away_defense_allowed, off_passing_yards_qtr_1_away_defense_allowed,
                off_passing_yards_qtr_2_away_defense_allowed,off_passing_yards_qtr_3_away_defense_allowed,
                off_passing_yards_qtr_4_away_defense_allowed,off_rushing_yards_qtr_1_away_defense_allowed,
                off_rushing_yards_qtr_2_away_defense_allowed, off_rushing_yards_qtr_3_away_defense_allowed,
                off_rushing_yards_qtr_4_away_defense_allowed, home_yac, total_yac_qtr_1_home, total_yac_qtr_2_home, total_yac_qtr_3_home,
                total_yac_qtr_4_home, home_total_plays, total_sacks_home, total_ints_home, total_sacks_allow_home, total_ints_throw_home,
                home_total_time_pos, away_yac, total_yac_qtr_1_away, total_yac_qtr_2_away, total_yac_qtr_3_away,
                total_yac_qtr_4_away, away_total_plays, total_sacks_away, total_ints_away, total_sacks_allow_away, total_ints_throw_away,
                away_total_time_pos) %>% 
  dplyr::collect()
```

#### Dummies

```{r}
#create dummies for home_coach and away_coach
library(fastDummies)
model_big_data_use <- dummy_cols(model_big_data_use, select_columns = c("home_coach", "away_coach", "roof", "surface", "start_time"))
```

#### Split data into training and testing

```{r}
train_big <- model_big_data_use[model_basic_data_use$season %in% c(2018, 2019, 2020), ]
test_big <- setdiff(model_big_data_use, train_big)
```

### Convert data to DMatrix

```{r}
dtrain_big <- xgb.DMatrix(data = as.matrix(train_big[, -c(1,4:8)]), label = train_big$point_differential)
dtest_big <- xgb.DMatrix(data = as.matrix(test_big[, -c(1, 4:8)]), label = test_big$point_differential)
```

### XGBoost Model

#### Train Model

```{r}
set.seed(111111)
model_big <- xgboost(data = dtrain_big, #set training data
                      nrounds = 100, #set number of rounds
                      verbose = 1, #prints out fit
                      print_every_n = 20 #prints out result every 20th iteration
                      )
```

#### Variable Importance

```{r}
# Extract importance
imp_mat <- xgb.importance(model = model_big)
# Plot importance (top 10 variables)
xgb.plot.importance(imp_mat, top_n = 20)
```
#### Test Model

```{r}
library(Metrics)

big_model_preds <- predict(model_big, dtest_big)

rmse(test_big$point_differential, big_model_preds)
```

#### Plot Actual vs Predicted

```{r}
plot(test_big$point_differential, big_model_preds)
```

